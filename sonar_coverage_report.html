<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代码质量分析报告</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1890ff;
            --success-color: #52c41a;
            --error-color: #ff4d4f;
            --text-primary: #262626;
            --text-secondary: #8c8c8c;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --border-radius: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 24px;
            color: var(--text-primary);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        .header .timestamp {
            color: var(--text-secondary);
            font-size: 14px;
            background: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* Summary Cards */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }
        .card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 2px -2px rgba(0, 0, 0, 0.16), 0 3px 6px 0 rgba(0, 0, 0, 0.12), 0 5px 12px 4px rgba(0, 0, 0, 0.09);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .card-title {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }
        .card-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-primary);
        }
        .card-icon {
            float: right;
            font-size: 24px;
            opacity: 0.2;
        }

        /* Chart Section */
        .chart-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* Filter & Table Section */
        .data-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            border: 1px solid #d9d9d9;
            background: #fff;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-primary);
        }
        .btn.active {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: #e6f7ff;
        }
        .btn:hover {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .search-box {
            position: relative;
        }
        .search-box input {
            padding: 8px 12px 8px 35px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            width: 250px;
            outline: none;
            transition: border-color 0.3s;
        }
        .search-box input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            text-align: left;
            padding: 16px;
            background: #fafafa;
            border-bottom: 1px solid #f0f0f0;
            color: var(--text-primary);
            cursor: pointer;
            user-select: none;
            transition: background 0.3s;
        }
        th:hover {
            background: #f0f0f0;
        }
        td {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.3s;
        }
        tr:hover td {
            background: #fafafa;
        }

        .progress-bar-bg {
            background-color: #f5f5f5;
            height: 8px;
            border-radius: 4px;
            width: 100%;
            max-width: 150px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid;
        }
        .status-pass { background: #f6ffed; border-color: #b7eb8f; color: #52c41a; }
        .status-fail { background: #fff2f0; border-color: #ffccc7; color: #ff4d4f; }

        .sort-icon {
            margin-left: 5px;
            color: #bfbfbf;
            font-size: 12px;
        }
        .sort-active {
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .summary-row { grid-template-columns: 1fr 1fr; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .search-box input { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>代码质量覆盖率看板</h1>
            <div class="timestamp"><i class="far fa-clock"></i> 更新时间: 2025-12-17 20:54:38</div>
        </div>

        <div class="summary-row">
            <div class="card">
                <i class="fas fa-cube card-icon" style="color: #1890ff;"></i>
                <div class="card-title">项目总数</div>
                <div class="card-value">7</div>
            </div>
            <div class="card">
                <i class="fas fa-check-circle card-icon" style="color: #52c41a;"></i>
                <div class="card-title">达标率 (≥50.0%)</div>
                <div class="card-value">14.3%</div>
            </div>
            <div class="card">
                <i class="fas fa-chart-line card-icon" style="color: #722ed1;"></i>
                <div class="card-title">平均新代码覆盖率</div>
                <div class="card-value">20.7%</div>
            </div>
            <div class="card">
                <i class="fas fa-exclamation-triangle card-icon" style="color: #ff4d4f;"></i>
                <div class="card-title">需关注项目</div>
                <div class="card-value" style="color: var(--error-color)">6</div>
            </div>
        </div>

        <div class="chart-section">
            <div id="mainChart" style="width: 100%; height: 400px;"></div>
        </div>

        <div class="data-section">
            <div class="toolbar">
                <div class="filter-group">
                    <button class="btn active" onclick="filterStatus('all', this)">全部项目</button>
                    <button class="btn" onclick="filterStatus('pass', this)">✅ 已达标</button>
                    <button class="btn" onclick="filterStatus('fail', this)">⚠️ 未达标</button>
                </div>
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="搜索项目名称..." onkeyup="handleSearch()">
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th onclick="sortTable('project_key')">项目名称 <i class="fas fa-sort sort-icon" id="sort-project_key"></i></th>
                        <th onclick="sortTable('overall_coverage')">整体覆盖率 <i class="fas fa-sort sort-icon" id="sort-overall_coverage"></i></th>
                        <th onclick="sortTable('new_coverage')">新代码覆盖率 <i class="fas fa-sort sort-icon" id="sort-new_coverage"></i></th>
                        <th onclick="sortTable('status')">状态 <i class="fas fa-sort sort-icon" id="sort-status"></i></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // 原始数据
        const rawData = [{"project_key": "oms-api", "overall_coverage": 26.8, "new_coverage": 54.6, "timestamp": "2025-12-17 20:54:33", "status": "pass"}, {"project_key": "rps-api", "overall_coverage": 9.6, "new_coverage": 38.7, "timestamp": "2025-12-17 20:54:34", "status": "fail"}, {"project_key": "drivermgmt-api", "overall_coverage": 8.9, "new_coverage": 47.2, "timestamp": "2025-12-17 20:54:35", "status": "fail"}, {"project_key": "tracking-api", "overall_coverage": 0.0, "new_coverage": 0.0, "timestamp": "2025-12-17 20:54:36", "status": "fail"}, {"project_key": "pos-exchange-api", "overall_coverage": 0.0, "new_coverage": 0.0, "timestamp": "2025-12-17 20:54:37", "status": "fail"}, {"project_key": "pos-admin-api", "overall_coverage": 3.8, "new_coverage": 4.4, "timestamp": "2025-12-17 20:54:38", "status": "fail"}, {"project_key": "pos-api", "overall_coverage": 0.0, "new_coverage": 0.0, "timestamp": "2025-12-17 20:54:38", "status": "fail"}];
        const threshold = 50.0;

        // 当前状态
        let currentData = [...rawData];
        let currentFilter = 'all';
        let sortConfig = { key: 'new_coverage', dir: 'asc' }; // 默认按新代码覆盖率升序，方便看问题

        // 初始化
        window.onload = function() {
            renderChart();
            applyFilterAndSort();
        };

        // 渲染图表
        function renderChart() {
            const chartDom = document.getElementById('mainChart');
            const myChart = echarts.init(chartDom);

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                legend: {
                    bottom: 0
                },
                grid: {
                    left: '20px', right: '20px', bottom: '40px', top: '20px',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: rawData.map(i => i.project_key),
                    axisLabel: { rotate: 30, color: '#666' }
                },
                yAxis: {
                    type: 'value',
                    max: 100,
                    splitLine: { lineStyle: { type: 'dashed', color: '#eee' } }
                },
                series: [
                    {
                        name: '整体覆盖率',
                        type: 'bar',
                        barGap: 0.2,
                        itemStyle: { color: '#1890ff', borderRadius: [4,4,0,0] },
                        data: rawData.map(i => i.overall_coverage)
                    },
                    {
                        name: '新代码覆盖率',
                        type: 'bar',
                        itemStyle: {
                            color: function(params) {
                                return params.value < threshold ? '#ff4d4f' : '#52c41a';
                            },
                            borderRadius: [4,4,0,0]
                        },
                        data: rawData.map(i => i.new_coverage),
                        markLine: {
                            data: [{ yAxis: threshold, name: '达标线' }],
                            lineStyle: { color: '#faad14', type: 'dashed' }
                        }
                    }
                ]
            };
            myChart.setOption(option);
            window.addEventListener('resize', () => myChart.resize());

            // 图表点击联动过滤
            myChart.on('click', function(params) {
                document.getElementById('searchInput').value = params.name;
                handleSearch();
                // 滚动到表格
                document.querySelector('.data-section').scrollIntoView({ behavior: 'smooth' });
            });
        }

        // 搜索处理
        function handleSearch() {
            applyFilterAndSort();
        }

        // 状态筛选处理
        function filterStatus(status, btn) {
            currentFilter = status;
            // 更新按钮样式
            document.querySelectorAll('.filter-group .btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            applyFilterAndSort();
        }

        // 排序处理
        function sortTable(key) {
            if (sortConfig.key === key) {
                sortConfig.dir = sortConfig.dir === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = key;
                sortConfig.dir = 'desc'; // 默认降序
            }
            applyFilterAndSort();
            updateSortIcons(key, sortConfig.dir);
        }

        // 应用过滤和排序逻辑
        function applyFilterAndSort() {
            const query = document.getElementById('searchInput').value.toLowerCase();

            // 1. 过滤
            let temp = rawData.filter(item => {
                const matchesSearch = item.project_key.toLowerCase().includes(query);
                const matchesStatus = currentFilter === 'all' || item.status === currentFilter;
                return matchesSearch && matchesStatus;
            });

            // 2. 排序
            temp.sort((a, b) => {
                let valA = a[sortConfig.key];
                let valB = b[sortConfig.key];

                // 如果是字符串比较
                if (typeof valA === 'string') {
                    return sortConfig.dir === 'asc' 
                        ? valA.localeCompare(valB) 
                        : valB.localeCompare(valA);
                }

                // 数字比较
                return sortConfig.dir === 'asc' ? valA - valB : valB - valA;
            });

            renderTable(temp);
        }

        // 渲染表格DOM
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 30px; color: #999;">没有找到匹配的数据</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');

                const overallHtml = createProgress(item.overall_coverage, '#1890ff');
                const newHtml = createProgress(item.new_coverage, item.new_coverage < threshold ? '#ff4d4f' : '#52c41a');

                const badgeClass = item.status === 'pass' ? 'status-pass' : 'status-fail';
                const badgeText = item.status === 'pass' ? '达标' : '未达标';

                row.innerHTML = `
                    <td style="font-weight: 500;">${item.project_key}</td>
                    <td>${overallHtml}</td>
                    <td>${newHtml}</td>
                    <td><span class="status-badge ${badgeClass}">${badgeText}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // 辅助函数：创建进度条HTML
        function createProgress(value, color) {
            return `
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width: ${value}%; background-color: ${color};"></div>
                </div>
                <span>${value}%</span>
            `;
        }

        // 更新排序图标UI
        function updateSortIcons(activeKey, dir) {
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'fas fa-sort sort-icon'; // reset
            });
            const target = document.getElementById(`sort-${activeKey}`);
            if (target) {
                target.className = `fas fa-sort-${dir === 'asc' ? 'up' : 'down'} sort-icon sort-active`;
            }
        }
    </script>
</body>
</html>