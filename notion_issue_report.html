<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue ç»Ÿè®¡æŠ¥å‘Š</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root {
            --primary: #2563eb; --primary-light: #3b82f6; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --purple: #8b5cf6; --teal: #14b8a6;
            --bg: #fff; --bg-secondary: #f8fafc; --bg-tertiary: #f1f5f9;
            --text: #0f172a; --text-secondary: #475569; --text-muted: #94a3b8;
            --border: #e2e8f0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg-secondary); color: var(--text); line-height: 1.6; }
        .container { max-width: 1480px; margin: 0 auto; padding: 20px 24px; }

        /* ç´§å‡‘é¡¶éƒ¨æ  */
        .header { background: var(--bg); border-radius: 12px; padding: 14px 20px; margin-bottom: 16px; border: 1px solid var(--border); }
        .header-row { display: flex; align-items: center; justify-content: space-between; gap: 16px; }
        .header-left { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .header h1 { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 8px; white-space: nowrap; }
        .header h1::before { content: 'ğŸ›'; font-size: 1.1rem; }
        .header .subtitle { color: var(--text-muted); font-size: 0.75rem; }

        /* ç»Ÿè®¡å¡ç‰‡ç»„ - ä½¿ç”¨ grid å¯¹é½ */
        .stat-cards { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; flex: 1; max-width: 600px; }
        .stat-card { text-align: center; padding: 8px 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border); }
        .stat-card .value { font-size: 1rem; font-weight: 700; display: flex; align-items: baseline; justify-content: center; gap: 2px; }
        .stat-card .prod { color: var(--danger); font-size: 0.85rem; font-weight: 600; }
        .stat-card .label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-top: 2px; }
        .stat-card.total .value { color: var(--primary); font-size: 1.1rem; }
        .stat-card.oms .value { color: var(--primary); }
        .stat-card.dms .value { color: var(--success); }
        .stat-card.pos .value { color: var(--warning); }
        .stat-card.bi .value { color: var(--teal); }

        /* ç­›é€‰é¢æ¿ */
        .filter-panel { background: var(--bg); border-radius: 12px; padding: 14px 18px; margin-bottom: 16px; border: 1px solid var(--border); }
        .filter-main { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .filter-group { display: flex; align-items: center; gap: 6px; }
        .filter-group label { font-size: 0.7rem; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; white-space: nowrap; }

        /* æ—¥æœŸå¿«æ·é€‰æ‹©å™¨ */
        .date-presets { display: flex; gap: 4px; flex-wrap: wrap; }
        .date-preset { padding: 5px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: var(--bg); transition: all 0.15s; white-space: nowrap; }
        .date-preset:hover { border-color: var(--primary-light); background: var(--bg-secondary); }
        .date-preset.active { background: var(--primary); color: white; border-color: var(--primary); }
        .date-custom { display: flex; align-items: center; gap: 4px; }
        .date-custom input { padding: 5px 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.75rem; width: 110px; }
        .date-custom input:focus { outline: none; border-color: var(--primary); }

        /* Chip æ ·å¼ */
        .chip-group { display: flex; gap: 4px; flex-wrap: wrap; }
        .chip { display: inline-flex; align-items: center; padding: 5px 10px; border-radius: 14px; font-size: 0.75rem; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: var(--bg); transition: all 0.15s; user-select: none; }
        .chip:hover { border-color: var(--primary-light); background: var(--bg-secondary); }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        .chip-OMS.active { background: var(--primary); border-color: var(--primary); }
        .chip-DMS.active { background: var(--success); border-color: var(--success); }
        .chip-POS.active { background: var(--warning); border-color: var(--warning); }
        .chip-BI.active { background: var(--teal); border-color: var(--teal); }
        .chip-prod.active { background: var(--danger); border-color: var(--danger); }

        /* æœç´¢æ¡† */
        .search-box { position: relative; }
        .search-box input { padding: 6px 10px 6px 28px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.75rem; width: 140px; }
        .search-box input:focus { outline: none; border-color: var(--primary); }
        .search-box::before { content: 'ğŸ”'; position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; opacity: 0.5; }

        /* æŠ˜å åŒºåŸŸ */
        .filter-expand { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); display: none; }
        .filter-expand.show { display: block; }
        .filter-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
        .filter-row:last-child { margin-bottom: 0; }
        .filter-row-label { font-size: 0.65rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; min-width: 45px; }

        /* æŒ‰é’® */
        .btn { padding: 5px 12px; border: none; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; transition: all 0.15s; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-secondary); }
        .btn-danger { background: linear-gradient(135deg, #dc2626, #ef4444); color: white; }
        .btn-toggle { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-toggle.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* å›¾è¡¨å¸ƒå±€ */
        .charts-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px; }
        .charts-full { margin-bottom: 16px; }
        .chart-card { background: var(--bg); border-radius: 12px; padding: 16px; border: 1px solid var(--border); }
        .chart-card h3 { font-size: 0.9rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .chart-card h3 .hint { font-size: 0.7rem; color: var(--text-muted); font-weight: 400; }
        .chart-container { position: relative; height: 260px; }
        .chart-container.tall { height: 300px; }

        /* è¡¨æ ¼ */
        .table-section { background: var(--bg); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border); }
        .table-section h3 { font-size: 0.9rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 12px; text-align: left; }
        th { background: var(--bg-tertiary); font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; text-transform: uppercase; border-bottom: 2px solid var(--border); }
        td { border-bottom: 1px solid var(--border); font-weight: 500; font-size: 0.8rem; }
        tbody tr:hover { background: var(--bg-secondary); cursor: pointer; }
        tr.total-row { background: linear-gradient(135deg, rgba(37,99,235,0.05), rgba(139,92,246,0.05)); }
        tr.total-row td { border-top: 2px solid var(--primary-light); font-weight: 700; color: #1d4ed8; }

        /* Badge */
        .badge { display: inline-flex; padding: 3px 8px; border-radius: 5px; font-size: 0.65rem; font-weight: 700; }
        .group-OMS { background: rgba(37,99,235,0.1); color: var(--primary); }
        .group-DMS { background: rgba(16,185,129,0.1); color: var(--success); }
        .group-POS { background: rgba(245,158,11,0.1); color: var(--warning); }
        .group-BI { background: rgba(20,184,166,0.1); color: var(--teal); }
        .env-prod { background: rgba(220,38,38,0.15); color: #dc2626; }
        .env-uat { background: rgba(245,158,11,0.1); color: var(--warning); }
        .env-sit1 { background: rgba(16,185,129,0.1); color: var(--success); }
        .severity-é˜»å¡æ€§ { background: rgba(220,38,38,0.15); color: #dc2626; }
        .severity-å…³é”®é—®é¢˜ { background: rgba(239,68,68,0.1); color: var(--danger); }
        .severity-æ™®é€šé—®é¢˜ { background: rgba(139,92,246,0.1); color: var(--purple); }

        /* è¯¦æƒ…åˆ—è¡¨ */
        .detail-section { background: var(--bg); border-radius: 12px; padding: 16px; border: 1px solid var(--border); margin-bottom: 16px; }
        .detail-header-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        .detail-header-bar h3 { font-size: 0.9rem; display: flex; align-items: center; gap: 8px; margin: 0; }
        .detail-filters { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .detail-filters .chip-group { gap: 4px; }
        .btn-sm { padding: 4px 10px; font-size: 0.7rem; }
        .btn-sm.active { background: linear-gradient(135deg, #059669, #10b981); border-color: #059669; }
        .detail-count { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: auto; }
        .detail-list { display: flex; flex-direction: column; gap: 8px; max-height: 450px; overflow-y: auto; }
        .detail-item { background: var(--bg-secondary); border-radius: 8px; padding: 12px 14px; border: 2px solid transparent; cursor: pointer; transition: all 0.15s; }
        .detail-item:hover { border-color: var(--primary-light); background: var(--bg); }
        .detail-item.expanded { border-color: var(--primary); background: var(--bg); }
        .detail-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .detail-title { font-weight: 600; font-size: 0.85rem; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .detail-meta { display: flex; gap: 4px; align-items: center; flex-wrap: wrap; }
        .detail-date { color: var(--text-muted); font-size: 0.75rem; }
        .detail-body { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); display: none; }
        .detail-item.expanded .detail-body { display: block; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; }
        .detail-field { display: flex; flex-direction: column; gap: 2px; }
        .field-label { color: var(--text-muted); font-size: 0.65rem; text-transform: uppercase; }
        .field-value { font-weight: 500; font-size: 0.8rem; }
        .btn-link { display: inline-flex; align-items: center; gap: 4px; padding: 5px 10px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; border-radius: 5px; text-decoration: none; font-size: 0.75rem; font-weight: 600; }

        .footer { text-align: center; padding: 16px; color: var(--text-muted); font-size: 0.75rem; }
        .empty-state { color: var(--text-muted); text-align: center; padding: 30px 16px; }
        .empty-state .icon { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.3; }

        @media (max-width: 1200px) { 
            .charts-row { grid-template-columns: 1fr; }
            .stat-cards { grid-template-columns: repeat(5, 1fr); }
        }
        
        @media (max-width: 768px) {
            .container { padding: 12px; }
            .header-row { flex-direction: column; align-items: stretch; gap: 12px; }
            .stat-cards { max-width: none; grid-template-columns: repeat(3, 1fr); gap: 8px; }
            .stat-card { padding: 6px 8px; }
            .stat-card .value { font-size: 0.9rem; }
            .stat-card .label { font-size: 0.6rem; }
            
            .filter-main { flex-direction: column; align-items: stretch; gap: 8px; }
            .filter-group { flex-direction: column; align-items: flex-start; gap: 4px; }
            .filter-group label { margin-bottom: 2px; }
            .date-presets { justify-content: flex-start; gap: 3px; }
            .date-preset { padding: 4px 8px; font-size: 0.7rem; }
            .chip { padding: 4px 8px; font-size: 0.7rem; }
            .search-box input { width: 100%; }
            
            .chart-card { padding: 12px; }
            .chart-card h3 { font-size: 0.85rem; margin-bottom: 8px; }
            .chart-container { height: 220px; }
            .chart-container.tall { height: 240px; }
            
            .detail-header { flex-direction: column; align-items: flex-start; gap: 6px; }
            .detail-meta { flex-wrap: wrap; gap: 3px; }
            .detail-title { font-size: 0.8rem; margin-bottom: 4px; }
            .detail-grid { grid-template-columns: 1fr; }
            .detail-item { padding: 10px 12px; }
        }
        
        @media (max-width: 480px) {
            .container { padding: 8px; }
            .header { padding: 10px 12px; }
            .header h1 { font-size: 1rem; }
            
            .stat-cards { grid-template-columns: repeat(2, 1fr); gap: 6px; }
            .stat-card { padding: 5px 6px; }
            .stat-card .value { font-size: 0.85rem; }
            .stat-card .prod { font-size: 0.75rem; }
            .stat-card .label { font-size: 0.55rem; }
            
            .filter-panel { padding: 10px 12px; }
            .btn { padding: 4px 8px; font-size: 0.7rem; }
            
            .chart-card { padding: 10px; }
            .chart-card h3 { font-size: 0.8rem; }
            .chart-container { height: 200px; }
            .chart-container.tall { height: 220px; }
            
            .detail-section { padding: 12px; }
            .detail-item { padding: 8px 10px; }
            .detail-title { font-size: 0.75rem; }
            .badge { padding: 2px 6px; font-size: 0.6rem; }
            .detail-date { font-size: 0.7rem; }
            .btn-link { padding: 3px 6px; font-size: 0.7rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç´§å‡‘é¡¶éƒ¨æ  -->
        <header class="header">
            <div class="header-row">
                <div class="header-left">
                    <h1>Issue ç»Ÿè®¡æŠ¥å‘Š</h1>
                    <span class="subtitle">2026-01-26T12:29:54.186332</span>
                </div>
                <div class="stat-cards">
                    <div class="stat-card total">
                        <div class="value"><span id="statTotal">0</span><span class="prod">/<span id="statTotalProd">0</span></span></div>
                        <div class="label">æ€»æ•°/PROD</div>
                    </div>
                    <div class="stat-card oms">
                        <div class="value"><span id="statOms">0</span><span class="prod">/<span id="statOmsProd">0</span></span></div>
                        <div class="label">OMS</div>
                    </div>
                    <div class="stat-card dms">
                        <div class="value"><span id="statDms">0</span><span class="prod">/<span id="statDmsProd">0</span></span></div>
                        <div class="label">DMS</div>
                    </div>
                    <div class="stat-card pos">
                        <div class="value"><span id="statPos">0</span><span class="prod">/<span id="statPosProd">0</span></span></div>
                        <div class="label">POS</div>
                    </div>
                    <div class="stat-card bi">
                        <div class="value"><span id="statBi">0</span><span class="prod">/<span id="statBiProd">0</span></span></div>
                        <div class="label">BI</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- ç­›é€‰é¢æ¿ -->
        <div class="filter-panel">
            <div class="filter-main">
                <div class="filter-group">
                    <label>æ—¶é—´</label>
                    <div class="date-presets" id="datePresets">
                        <span class="date-preset active" data-range="thisMonth">æœ¬æœˆ</span>
                        <span class="date-preset" data-range="lastMonth">ä¸Šæœˆ</span>
                        <span class="date-preset" data-range="last7days">è¿‘7å¤©</span>
                        <span class="date-preset" data-range="last30days">è¿‘30å¤©</span>
                        <span class="date-preset" data-range="thisYear">1å¹´å†…</span>
                        <span class="date-preset" data-range="custom">è‡ªå®šä¹‰</span>
                    </div>
                    <div class="date-custom" id="dateCustom" style="display:none;">
                        <input type="date" id="startDate">
                        <span style="color:var(--text-muted);font-size:0.7rem;">è‡³</span>
                        <input type="date" id="endDate">
                    </div>
                </div>
                <div class="filter-group">
                    <label>é¡¹ç›®ç»„</label>
                    <div class="chip-group" id="groupChips">
                        <span class="chip chip-OMS" data-value="OMS">OMS</span><span class="chip chip-DMS" data-value="DMS">DMS</span><span class="chip chip-POS" data-value="POS">POS</span><span class="chip chip-BI" data-value="BI">BI</span>
                    </div>
                </div>
                <div class="search-box">
                    <input type="text" id="searchKeyword" placeholder="æœç´¢æ ‡é¢˜...">
                </div>
                <button class="btn btn-toggle" onclick="toggleExpand()" id="expandBtn">âš™ï¸ æ›´å¤š</button>
                <button class="btn btn-secondary" onclick="resetFilters()">ğŸ”„ é‡ç½®</button>
                <button class="btn btn-danger" onclick="filterProdThisMonth()">ğŸš¨ æœ¬æœˆPROD</button>
            </div>

            <!-- æŠ˜å çš„ç­›é€‰æ¡ä»¶ -->
            <div class="filter-expand" id="filterExpand">
                <div class="filter-row">
                    <span class="filter-row-label">ç¯å¢ƒ</span>
                    <div class="chip-group" id="envChips">
                        
                    </div>
                </div>
                <div class="filter-row">
                    <span class="filter-row-label">ä¸¥é‡ç¨‹åº¦</span>
                    <div class="chip-group" id="severityChips">
                        
                    </div>
                </div>
                <div class="filter-row">
                    <span class="filter-row-label">é—®é¢˜ç±»å‹</span>
                    <div class="chip-group" id="typeChips">
                        
                    </div>
                </div>
                <div class="filter-row">
                    <span class="filter-row-label">å¹´ä»½ç»Ÿè®¡</span>
                    <select id="yearSelect" style="padding: 5px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.75rem; background: var(--bg); cursor: pointer;">
                        <option value="">è¯·é€‰æ‹©å¹´ä»½</option>
                    </select>
                    <span style="font-size: 0.7rem; color: var(--text-muted);">é€‰æ‹©å¹´ä»½åæ˜¾ç¤ºå­£åº¦è¶‹åŠ¿å›¾</span>
                </div>
            </div>
        </div>

        <!-- å›¾è¡¨ -->
        <div class="charts-row">
            <div class="chart-card"><h3>ğŸ·ï¸ é—®é¢˜ç±»å‹åˆ†å¸ƒ</h3><div class="chart-container"><canvas id="typeChart"></canvas></div></div>
            <div class="chart-card"><h3>ğŸ¢ å„é¡¹ç›®ç»„ç¯å¢ƒå¯¹æ¯”</h3><div class="chart-container"><canvas id="groupChart"></canvas></div></div>
        </div>

        <div class="charts-row">
            <div class="chart-card"><h3>ğŸ“ˆ å„é¡¹ç›®ç»„æ¯æœˆIssueè¶‹åŠ¿ <span class="hint">ï¼ˆæœ€è¿‘12ä¸ªæœˆï¼‰</span></h3><div class="chart-container tall"><canvas id="trendChart"></canvas></div></div>
            <div class="chart-card"><h3>ğŸ’» æŠ€æœ¯ç±»åˆ†å¸ƒç»Ÿè®¡</h3><div class="chart-container"><canvas id="techChart"></canvas></div></div>
        </div>

        <div class="charts-row">
            <div class="chart-card"><h3>ğŸš¨ PRODç¯å¢ƒIssueåˆ†å¸ƒ <span class="hint" id="prodPieHint">ï¼ˆå½“å‰ç­›é€‰æ—¶é—´æ®µï¼‰</span></h3><div class="chart-container"><canvas id="prodPieChart"></canvas></div></div>
            <div class="chart-card"><h3>ğŸš¨ å„é¡¹ç›®ç»„PRODç¯å¢ƒè¶‹åŠ¿ <span class="hint">ï¼ˆæœ€è¿‘12ä¸ªæœˆï¼‰</span></h3><div class="chart-container"><canvas id="prodTrendChart"></canvas></div></div>
        </div>

        <!-- å­£åº¦ç»Ÿè®¡å›¾è¡¨ï¼ˆé€‰æ‹©å¹´ä»½åæ˜¾ç¤ºï¼‰ -->
        <div class="charts-row" id="quarterlyCharts" style="display:none;">
            <div class="chart-card">
                <h3 id="quarterlyIssueTitle">ğŸ“Š 2025å¹´å„é¡¹ç›®ç»„IssueæŒ‰å­£åº¦è¶‹åŠ¿</h3>
                <div class="chart-container" style="height: 280px;"><canvas id="quarterlyIssueChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h3 id="quarterlyProdTitle">ğŸš¨ 2025å¹´PRODç¯å¢ƒIssueæŒ‰å­£åº¦è¶‹åŠ¿</h3>
                <div class="chart-container" style="height: 280px;"><canvas id="quarterlyProdChart"></canvas></div>
            </div>
        </div>

        <!-- è¯¦æƒ…åˆ—è¡¨ -->
        <div class="detail-section">
            <div class="detail-header-bar">
                <h3>ğŸ“ Issue è¯¦æƒ…åˆ—è¡¨</h3>
                <div class="detail-filters">
                    <div class="chip-group" id="detailGroupChips">
                        <span class="chip chip-OMS" data-value="OMS">OMS</span><span class="chip chip-DMS" data-value="DMS">DMS</span><span class="chip chip-POS" data-value="POS">POS</span><span class="chip chip-BI" data-value="BI">BI</span>
                    </div>
                    <button class="btn btn-danger btn-sm" id="detailProdBtn" onclick="toggleProdThisMonth()">ğŸš¨ æœ¬æœˆPROD</button>
                </div>
                <span class="detail-count" id="detailCount">0</span>
            </div>
            <div class="detail-list" id="detailList"></div>
        </div>

        <footer class="footer">SpeedX Issue ç»Ÿè®¡æŠ¥å‘Š Â· æ•°æ®è‡ªåŠ¨ç”Ÿæˆ</footer>
    </div>

    <script>
        const rawData = [];
        let filteredData = [...rawData];
        let typeChart = null, groupChart = null, trendChart = null, prodTrendChart = null, prodPieChart = null, techChart = null;
        let quarterlyIssueChart = null, quarterlyProdChart = null;
        let currentDateRange = 'thisMonth';
        let selectedYear = null;

        const colors = ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#14b8a6', '#ec4899', '#6366f1', '#06b6d4', '#f97316'];
        const groupColors = { 'OMS': '#2563eb', 'DMS': '#10b981', 'POS': '#f59e0b', 'BI': '#14b8a6' };
        const prodColors = { 'OMS': '#dc2626', 'DMS': '#059669', 'POS': '#d97706', 'BI': '#0d9488' };
        
        // æ£€æµ‹å±å¹•å°ºå¯¸çš„è¾…åŠ©å‡½æ•°
        const isMobile = () => window.innerWidth <= 768;
        const isSmallMobile = () => window.innerWidth <= 480;

        const getModule = item => item['æ¨¡å—'] || item['é¡¹ç›®ç»„'] || '';
        const mapGroup = g => {
            if (!g) return '';
            const u = g.toUpperCase();
            if (u === 'RPS' || u === 'OMS') return 'OMS';
            if (u === 'TRK' || u === 'SNS' || u === 'POS') return 'POS';
            if (u === 'BI') return 'BI';
            return u === 'DMS' ? 'DMS' : u;
        };

        Chart.register(ChartDataLabels);
        Chart.defaults.plugins.datalabels.display = false;

        const getSelectedChips = containerId => Array.from(document.querySelectorAll(`#${containerId} .chip.active`)).map(c => c.dataset.value);

        // æ—¥æœŸèŒƒå›´è®¡ç®—
        function getDateRange(rangeType) {
            const today = new Date();
            let start, end;

            switch(rangeType) {
                case 'thisMonth':
                    start = new Date(today.getFullYear(), today.getMonth(), 1);
                    end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'lastMonth':
                    start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    end = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                case 'last7days':
                    end = new Date(today);
                    start = new Date(today);
                    start.setDate(start.getDate() - 6);
                    break;
                case 'last30days':
                    end = new Date(today);
                    start = new Date(today);
                    start.setDate(start.getDate() - 29);
                    break;
                case 'thisYear':
                    start = new Date(today);
                    start.setFullYear(start.getFullYear() - 1);
                    end = new Date(today);
                    break;
                case 'specificYear':
                    if (!selectedYear) return null;
                    start = new Date(selectedYear, 0, 1);
                    end = new Date(selectedYear, 11, 31);
                    break;
                default:
                    return null;
            }
            return { start, end };
        }

        function setDateRange(rangeType) {
            currentDateRange = rangeType;
            document.querySelectorAll('.date-preset').forEach(el => el.classList.remove('active'));
            document.querySelector(`.date-preset[data-range="${rangeType}"]`)?.classList.add('active');

            const customEl = document.getElementById('dateCustom');
            if (rangeType === 'custom') {
                customEl.style.display = 'flex';
            } else {
                customEl.style.display = 'none';
                const range = getDateRange(rangeType);
                if (range) {
                    document.getElementById('startDate').value = range.start.toISOString().split('T')[0];
                    document.getElementById('endDate').value = range.end.toISOString().split('T')[0];
                }
            }
            
            // éå¹´ä»½ç­›é€‰æ—¶éšè—å­£åº¦å›¾è¡¨å¹¶é‡ç½®ä¸‹æ‹‰æ¡†
            if (rangeType !== 'specificYear') {
                document.getElementById('quarterlyCharts').style.display = 'none';
                document.getElementById('yearSelect').value = '';
                selectedYear = null;
            }
            
            applyFilters();
        }

        function initDatePresets() {
            document.querySelectorAll('.date-preset[data-range]').forEach(el => {
                el.addEventListener('click', () => setDateRange(el.dataset.range));
            });
        }

        function initYearSelect() {
            const select = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            // ç”Ÿæˆ2024å¹´åˆ°å½“å‰å¹´ä»½çš„é€‰é¡¹
            for (let year = 2024; year <= currentYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'å¹´';
                select.appendChild(option);
            }
            
            // å¹´ä»½é€‰æ‹©äº‹ä»¶
            select.addEventListener('change', (e) => {
                const year = parseInt(e.target.value);
                if (!year) {
                    document.getElementById('quarterlyCharts').style.display = 'none';
                    selectedYear = null;
                    return;
                }
                
                selectedYear = year;
                currentDateRange = 'specificYear';
                
                // ç§»é™¤å…¶ä»–æŒ‰é’®çš„activeçŠ¶æ€
                document.querySelectorAll('.date-preset').forEach(el => el.classList.remove('active'));
                
                // æ›´æ–°æ—¥æœŸèŒƒå›´è¾“å…¥æ¡†ï¼ˆå…³é”®ï¼šè®©applyFiltersä½¿ç”¨æ­£ç¡®çš„æ—¥æœŸèŒƒå›´ï¼‰
                document.getElementById('startDate').value = year + '-01-01';
                document.getElementById('endDate').value = year + '-12-31';
                document.getElementById('dateCustom').style.display = 'none';
                
                // æ›´æ–°å›¾è¡¨æ ‡é¢˜
                document.getElementById('quarterlyIssueTitle').textContent = 'ğŸ“Š ' + year + 'å¹´å„é¡¹ç›®ç»„IssueæŒ‰å­£åº¦è¶‹åŠ¿';
                document.getElementById('quarterlyProdTitle').textContent = 'ğŸš¨ ' + year + 'å¹´PRODç¯å¢ƒIssueæŒ‰å­£åº¦è¶‹åŠ¿';
                
                // æ˜¾ç¤ºå­£åº¦å›¾è¡¨
                document.getElementById('quarterlyCharts').style.display = 'grid';
                
                // æ¸²æŸ“å­£åº¦å›¾è¡¨
                renderQuarterlyCharts(year);
                
                // åº”ç”¨ç­›é€‰ï¼ˆä¼šä½¿ç”¨æ›´æ–°åçš„startDateå’ŒendDateï¼‰
                applyFilters();
            });
        }


        function calcQuarterlyTrend(year, filterFn) {
            const result = {
                labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                OMS: [0, 0, 0, 0],
                DMS: [0, 0, 0, 0],
                POS: [0, 0, 0, 0],
                BI: [0, 0, 0, 0]
            };
            const quarterRanges = [[1, 3], [4, 6], [7, 9], [10, 12]];
            
            rawData.forEach(item => {
                if (filterFn && !filterFn(item)) return;
                
                const dateStr = item.parsed_create_date;
                if (!dateStr) return;
                
                const date = new Date(dateStr);
                if (date.getFullYear() !== year) return;
                
                const month = date.getMonth() + 1;
                const qIndex = quarterRanges.findIndex(r => month >= r[0] && month <= r[1]);
                const group = mapGroup(getModule(item));
                
                if (qIndex >= 0 && result[group] !== undefined) {
                    result[group][qIndex]++;
                }
            });
            
            return result;
        }

        function renderQuarterlyCharts(year) {
            // é”€æ¯æ—§å›¾è¡¨
            if (quarterlyIssueChart) quarterlyIssueChart.destroy();
            if (quarterlyProdChart) quarterlyProdChart.destroy();
            
            const issueCtx = document.getElementById('quarterlyIssueChart').getContext('2d');
            const prodCtx = document.getElementById('quarterlyProdChart').getContext('2d');
            
            // è®¡ç®—Issueè¶‹åŠ¿æ•°æ®
            const issueData = calcQuarterlyTrend(year, null);
            
            // è®¡ç®—PRODç¯å¢ƒIssueè¶‹åŠ¿æ•°æ®
            const prodData = calcQuarterlyTrend(year, item => (item['ç¯å¢ƒ'] || '').toLowerCase() === 'prod');
            
            const quarterlyGroupColors = {
                OMS: 'rgba(37, 99, 235, 0.85)',
                DMS: 'rgba(16, 185, 129, 0.85)',
                POS: 'rgba(245, 158, 11, 0.85)',
                BI: 'rgba(20, 184, 166, 0.85)'
            };
            
            const quarterlyProdColors = {
                OMS: 'rgba(220, 38, 38, 0.85)',
                DMS: 'rgba(5, 150, 105, 0.85)',
                POS: 'rgba(217, 119, 6, 0.85)',
                BI: 'rgba(13, 148, 136, 0.85)'
            };
            
            const createDatasets = (data, colorSet) => {
                return Object.keys(colorSet).map(group => ({
                    label: group,
                    data: data[group],
                    backgroundColor: colorSet[group],
                    hoverBackgroundColor: colorSet[group].replace('0.85', '1'),
                    borderRadius: 6,
                    borderSkipped: false,
                    barPercentage: 0.65,
                    categoryPercentage: 0.85
                }));
            };
            
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'rectRounded',
                            padding: 12,
                            font: { size: 11, weight: '500' }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 12, weight: '600' },
                        bodyFont: { size: 11 },
                        padding: 10,
                        cornerRadius: 6,
                        displayColors: true
                    },
                    datalabels: {
                        display: (context) => context.dataset.data[context.dataIndex] > 0,
                        color: '#374151',
                        anchor: 'end',
                        align: 'top',
                        offset: 2,
                        font: {
                            size: 10,
                            weight: '600'
                        },
                        formatter: (value) => value
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 12, weight: '600' } }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { 
                            stepSize: 1,
                            font: { size: 11 }
                        },
                        grid: { 
                            color: 'rgba(0, 0, 0, 0.05)',
                            drawBorder: false
                        }
                    }
                },
                animation: {
                    duration: 600,
                    easing: 'easeOutQuart'
                },
                layout: {
                    padding: {
                        top: 20
                    }
                }
            };
            
            // Issueè¶‹åŠ¿å›¾
            quarterlyIssueChart = new Chart(issueCtx, {
                type: 'bar',
                data: {
                    labels: issueData.labels,
                    datasets: createDatasets(issueData, quarterlyGroupColors)
                },
                options: chartOptions,
                plugins: [ChartDataLabels]
            });
            
            // PRODè¶‹åŠ¿å›¾
            quarterlyProdChart = new Chart(prodCtx, {
                type: 'bar',
                data: {
                    labels: prodData.labels,
                    datasets: createDatasets(prodData, quarterlyProdColors)
                },
                options: chartOptions,
                plugins: [ChartDataLabels]
            });
        }

        function initChipEvents() {
            // æ™®é€šchipäº‹ä»¶ï¼ˆç¯å¢ƒã€ä¸¥é‡ç¨‹åº¦ã€é—®é¢˜ç±»å‹ï¼‰
            document.querySelectorAll('#envChips .chip, #severityChips .chip, #typeChips .chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    chip.classList.toggle('active');
                    applyFilters();
                });
            });
            
            // é¡¹ç›®ç»„chipåŒæ­¥äº‹ä»¶ï¼ˆä¸»ç­›é€‰æ å’Œè¯¦æƒ…åˆ—è¡¨æ åŒæ­¥ï¼‰
            document.querySelectorAll('#groupChips .chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    const value = chip.dataset.value;
                    chip.classList.toggle('active');
                    // åŒæ­¥åˆ°è¯¦æƒ…åˆ—è¡¨çš„chip
                    const detailChip = document.querySelector(`#detailGroupChips .chip[data-value="${value}"]`);
                    if (detailChip) detailChip.classList.toggle('active', chip.classList.contains('active'));
                    applyFilters();
                });
            });
            
            // è¯¦æƒ…åˆ—è¡¨é¡¹ç›®ç»„chip - å•é€‰æ¨¡å¼
            document.querySelectorAll('#detailGroupChips .chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    const value = chip.dataset.value;
                    const wasActive = chip.classList.contains('active');
                    
                    // å…ˆæ¸…é™¤æ‰€æœ‰è¯¦æƒ…åˆ—è¡¨å’Œä¸»ç­›é€‰æ çš„é¡¹ç›®ç»„chip
                    document.querySelectorAll('#detailGroupChips .chip, #groupChips .chip').forEach(c => c.classList.remove('active'));
                    
                    // å¦‚æœä¹‹å‰æœªæ¿€æ´»ï¼Œåˆ™æ¿€æ´»å½“å‰é€‰ä¸­çš„ï¼ˆå•é€‰ï¼‰
                    if (!wasActive) {
                        chip.classList.add('active');
                        const mainChip = document.querySelector(`#groupChips .chip[data-value="${value}"]`);
                        if (mainChip) mainChip.classList.add('active');
                    }
                    applyFilters();
                });
            });
        }

        function toggleExpand() {
            const expand = document.getElementById('filterExpand');
            const btn = document.getElementById('expandBtn');
            expand.classList.toggle('show');
            btn.classList.toggle('active');
            btn.textContent = expand.classList.contains('show') ? 'âš™ï¸ æ”¶èµ·' : 'âš™ï¸ æ›´å¤š';
        }

        function applyFilters() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const keyword = document.getElementById('searchKeyword').value.toLowerCase().trim();
            const groups = getSelectedChips('groupChips');
            const envs = getSelectedChips('envChips');
            const severities = getSelectedChips('severityChips');
            const types = getSelectedChips('typeChips');

            const startD = start ? new Date(start) : null;
            const endD = end ? new Date(end + 'T23:59:59') : null;

            filteredData = rawData.filter(item => {
                if (startD || endD) {
                    const d = item.parsed_create_date ? new Date(item.parsed_create_date) : null;
                    if (!d || (startD && d < startD) || (endD && d > endD)) return false;
                }
                if (keyword && !(item['issueæ ‡é¢˜'] || '').toLowerCase().includes(keyword)) return false;
                if (groups.length && !groups.includes(mapGroup(getModule(item)))) return false;
                if (envs.length && !envs.includes(item['ç¯å¢ƒ'])) return false;
                if (severities.length && !severities.includes(item['ä¸¥é‡ç¨‹åº¦'])) return false;
                if (types.length) {
                    const itemTypes = Array.isArray(item['é—®é¢˜ç±»å‹']) ? item['é—®é¢˜ç±»å‹'] : [item['é—®é¢˜ç±»å‹']];
                    if (!itemTypes.some(t => types.includes(t))) return false;
                }
                return true;
            });
            renderAll();
        }

        function resetFilters() {
            document.querySelectorAll('.chip-group .chip').forEach(c => c.classList.remove('active'));
            document.getElementById('searchKeyword').value = '';
            document.getElementById('detailProdBtn')?.classList.remove('active');
            setDateRange('thisMonth');
        }

        function filterProdThisMonth() {
            document.querySelectorAll('.chip-group .chip').forEach(c => c.classList.remove('active'));
            document.getElementById('searchKeyword').value = '';
            setDateRange('thisMonth');
            document.querySelector('#envChips .chip[data-value="prod"]')?.classList.add('active');
            document.getElementById('filterExpand').classList.add('show');
            document.getElementById('expandBtn').classList.add('active');
            document.getElementById('expandBtn').textContent = 'âš™ï¸ æ”¶èµ·';
            // æ›´æ–°è¯¦æƒ…åŒºæŒ‰é’®çŠ¶æ€
            document.getElementById('detailProdBtn')?.classList.add('active');
            applyFilters();
        }

        function toggleProdThisMonth() {
            const btn = document.getElementById('detailProdBtn');
            if (btn.classList.contains('active')) {
                // å·²æ¿€æ´»ï¼Œç‚¹å‡»åé‡ç½®ç­›é€‰
                btn.classList.remove('active');
                resetFilters();
            } else {
                // æœªæ¿€æ´»ï¼Œç‚¹å‡»åç­›é€‰æœ¬æœˆPROD
                filterProdThisMonth();
            }
        }

        function filterByGroup(g) {
            document.querySelectorAll('#groupChips .chip').forEach(c => c.classList.remove('active'));
            document.querySelector(`#groupChips .chip[data-value="${g}"]`)?.classList.add('active');
            applyFilters();
        }

        // æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡æ•°æ®
        function updateHeaderStats() {
            const stats = { total: 0, totalProd: 0, OMS: 0, OMSProd: 0, DMS: 0, DMSProd: 0, POS: 0, POSProd: 0, BI: 0, BIProd: 0 };

            filteredData.forEach(item => {
                const g = mapGroup(getModule(item));
                const isProd = (item['ç¯å¢ƒ'] || '').toLowerCase() === 'prod';

                stats.total++;
                if (isProd) stats.totalProd++;

                if (g === 'OMS') { stats.OMS++; if (isProd) stats.OMSProd++; }
                if (g === 'DMS') { stats.DMS++; if (isProd) stats.DMSProd++; }
                if (g === 'POS') { stats.POS++; if (isProd) stats.POSProd++; }
                if (g === 'BI') { stats.BI++; if (isProd) stats.BIProd++; }
            });

            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statTotalProd').textContent = stats.totalProd;
            document.getElementById('statOms').textContent = stats.OMS;
            document.getElementById('statOmsProd').textContent = stats.OMSProd;
            document.getElementById('statDms').textContent = stats.DMS;
            document.getElementById('statDmsProd').textContent = stats.DMSProd;
            document.getElementById('statPos').textContent = stats.POS;
            document.getElementById('statPosProd').textContent = stats.POSProd;
            document.getElementById('statBi').textContent = stats.BI;
            document.getElementById('statBiProd').textContent = stats.BIProd;
        }

        function renderAll() {
            updateHeaderStats();
            initCharts();
            renderDetailList();
        }

        function initCharts() {
            [typeChart, groupChart, trendChart, prodTrendChart, prodPieChart, techChart].forEach(c => c?.destroy());

            // é—®é¢˜ç±»å‹åˆ†å¸ƒ
            const typeData = calcDist(filteredData, 'é—®é¢˜ç±»å‹');
            const typeEntries = Object.entries(typeData).sort((a, b) => b[1] - a[1]);
            const typeLabels = typeEntries.map(e => e[0]);
            const typeValues = typeEntries.map(e => e[1]);

            typeChart = new Chart(document.getElementById('typeChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: typeLabels, datasets: [{ data: typeValues, backgroundColor: colors, borderColor: '#fff', borderWidth: 2 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: isMobile() ? '50%' : '55%',
                    plugins: {
                        legend: { 
                            position: isMobile() ? 'bottom' : 'right', 
                            labels: { 
                                padding: isMobile() ? 8 : 10, 
                                usePointStyle: true, 
                                font: { size: isMobile() ? 9 : 10 },
                                boxWidth: isMobile() ? 12 : 15
                            }
                        },
                        datalabels: {
                            display: true,
                            color: '#fff',
                            font: { weight: 'bold', size: isMobile() ? 10 : 11 },
                            formatter: (value, context) => {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = (value / total * 100);
                                return percentage > 3.5 ? percentage.toFixed(1) + '%' : '';
                            }
                        }
                    }
                }
            });

            // é¡¹ç›®ç»„ç¯å¢ƒå¯¹æ¯”
            const envData = calcGroupEnv(filteredData);
            const envs = Object.keys(envData.envs);
            const groups = Object.keys(envData.groups);
            groupChart = new Chart(document.getElementById('groupChart').getContext('2d'), {
                type: 'bar',
                data: { labels: groups, datasets: envs.map((env, i) => ({ label: env, data: groups.map(g => envData.groups[g][env] || 0), backgroundColor: colors[i % colors.length], borderRadius: isMobile() ? 2 : 4 })) },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: isMobile() ? 'bottom' : 'top', 
                            labels: { 
                                padding: isMobile() ? 8 : 10, 
                                usePointStyle: true, 
                                font: { size: isMobile() ? 9 : 10 },
                                boxWidth: isMobile() ? 12 : 15
                            } 
                        },
                        datalabels: {
                            display: !isSmallMobile(),
                            color: '#333',
                            font: { weight: '600', size: isMobile() ? 9 : 10 },
                            anchor: 'end',
                            align: 'top',
                            offset: 2,
                            formatter: (value) => value > 0 ? value : ''
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: { size: isMobile() ? 9 : 10 },
                                maxRotation: isMobile() ? 45 : 0
                            }
                        },
                        y: {
                            ticks: {
                                font: { size: isMobile() ? 9 : 10 }
                            }
                        }
                    }
                }
            });

            // PROD ç¯å¢ƒé¥¼å›¾ - ä½¿ç”¨ç­›é€‰åçš„æ•°æ®
            renderProdPieChart();
            // è¶‹åŠ¿å›¾
            renderTrendChart();
            renderProdTrendChart();
            // æŠ€æœ¯ç±»åˆ†å¸ƒå›¾
            renderTechChart();
        }

        function renderProdPieChart() {
            // ä½¿ç”¨ç­›é€‰åçš„æ•°æ®ç»Ÿè®¡ PROD
            const prodData = { 'OMS': 0, 'DMS': 0, 'POS': 0, 'BI': 0 };
            filteredData.forEach(item => {
                if ((item['ç¯å¢ƒ'] || '').toLowerCase() === 'prod') {
                    const g = mapGroup(getModule(item));
                    if (g && prodData[g] !== undefined) prodData[g]++;
                }
            });

            // æ›´æ–°æç¤ºæ–‡å­—
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const hintEl = document.getElementById('prodPieHint');
            if (start && end) {
                hintEl.textContent = `ï¼ˆ${start} è‡³ ${end}ï¼‰`;
            } else {
                hintEl.textContent = 'ï¼ˆå½“å‰ç­›é€‰æ—¶é—´æ®µï¼‰';
            }

            const labels = Object.keys(prodData).filter(k => prodData[k] > 0);
            const data = labels.map(k => prodData[k]);
            const bgColors = labels.map(k => prodColors[k]);

            if (prodPieChart) prodPieChart.destroy();

            prodPieChart = new Chart(document.getElementById('prodPieChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: bgColors, borderColor: '#fff', borderWidth: 2 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: isMobile() ? '50%' : '55%',
                    plugins: {
                        legend: { 
                            position: isMobile() ? 'bottom' : 'right', 
                            labels: { 
                                padding: isMobile() ? 8 : 10, 
                                usePointStyle: true, 
                                font: { size: isMobile() ? 9 : 10 },
                                boxWidth: isMobile() ? 12 : 15
                            } 
                        },
                        datalabels: {
                            display: !isSmallMobile(),
                            color: '#fff',
                            font: { weight: 'bold', size: isMobile() ? 11 : 13 },
                            formatter: (value) => value > 0 ? value : ''
                        }
                    }
                }
            });
        }

        function calcDist(data, field) {
            const dist = {};
            data.forEach(item => {
                let vals = [];
                const fieldValue = item[field];
                if (Array.isArray(fieldValue) && fieldValue.length > 0) {
                    fieldValue.forEach(v => {
                        if (v !== null && v !== undefined && String(v).trim() !== '') {
                            vals.push(String(v).trim());
                        }
                    });
                } else if (fieldValue !== null && fieldValue !== undefined && String(fieldValue).trim() !== '') {
                    vals.push(String(fieldValue).trim());
                }
                if (vals.length === 0) vals = ['æœªçŸ¥'];
                vals.forEach(v => {
                    dist[v] = (dist[v] || 0) + 1;
                });
            });
            return dist;
        }

        function calcGroupEnv(data) {
            const groups = { 'OMS': {}, 'DMS': {}, 'POS': {}, 'BI': {} };
            const envs = {};
            data.forEach(item => {
                const g = mapGroup(getModule(item));
                const rawEnv = item['ç¯å¢ƒ'] || 'æœªçŸ¥';
                // å°†æ‰€æœ‰éprodç¯å¢ƒå½’ç±»ä¸ºæµ‹è¯•ç¯å¢ƒ
                const env = rawEnv.toLowerCase() === 'prod' ? 'PROD' : 'æµ‹è¯•ç¯å¢ƒ';
                if (g && groups[g]) {
                    envs[env] = (envs[env] || 0) + 1;
                    groups[g][env] = (groups[g][env] || 0) + 1;
                }
            });
            return { groups, envs };
        }

        function getRecentMonths(count = 12) {
            const today = new Date();
            const months = [];
            for (let i = count - 1; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i + 1, 1);
                months.push(d.toISOString().substring(0, 7));
            }
            return months;
        }

        function calcMonthlyTrend(data, prodOnly = false) {
            const monthlyData = {};
            data.forEach(item => {
                const date = item.parsed_create_date;
                if (!date) return;
                if (prodOnly && (item['ç¯å¢ƒ'] || '').toLowerCase() !== 'prod') return;
                const month = date.substring(0, 7);
                const group = mapGroup(getModule(item));
                if (!monthlyData[month]) monthlyData[month] = { 'OMS': 0, 'DMS': 0, 'POS': 0, 'BI': 0 };
                if (group && monthlyData[month][group] !== undefined) monthlyData[month][group]++;
            });

            const recentMonths = getRecentMonths();
            recentMonths.forEach(m => { if (!monthlyData[m]) monthlyData[m] = { 'OMS': 0, 'DMS': 0, 'POS': 0, 'BI': 0 }; });

            return {
                months: recentMonths.map(m => parseInt(m.split('-')[1]) + 'æœˆ'),
                groups: {
                    'OMS': recentMonths.map(m => monthlyData[m].OMS),
                    'DMS': recentMonths.map(m => monthlyData[m].DMS),
                    'POS': recentMonths.map(m => monthlyData[m].POS),
                    'BI': recentMonths.map(m => monthlyData[m].BI)
                }
            };
        }

        function createTrendDatasets(trendData, colorsMap, suffix = '') {
            const selectedGroups = getSelectedChips('groupChips');
            const groupsToShow = selectedGroups.length ? selectedGroups : ['OMS', 'DMS', 'POS', 'BI'];
            return groupsToShow.map(g => ({
                label: g + suffix,
                data: trendData.groups[g],
                borderColor: colorsMap[g],
                backgroundColor: colorsMap[g] + '1A',
                tension: 0.3, fill: true, borderWidth: 2,
                pointRadius: isMobile() ? 3 : 4, 
                pointHoverRadius: isMobile() ? 5 : 6,
                pointBackgroundColor: colorsMap[g],
                pointBorderColor: '#fff', 
                pointBorderWidth: isMobile() ? 1 : 2
            }));
        }

        function getTrendChartOptions(gridColor = 'rgba(226, 232, 240, 0.6)') {
            return {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                layout: {
                    padding: {
                        top: 20,
                        right: 15,
                        bottom: 5,
                        left: 5
                    }
                },
                plugins: {
                    legend: { 
                        position: isMobile() ? 'bottom' : 'top', 
                        labels: { 
                            padding: isMobile() ? 8 : 12, 
                            usePointStyle: true, 
                            font: { weight: '600', size: isMobile() ? 9 : 10 },
                            boxWidth: isMobile() ? 12 : 15
                        } 
                    },
                    tooltip: { 
                        backgroundColor: 'rgba(15, 23, 42, 0.95)', 
                        titleFont: { size: 12, weight: '600' }, 
                        bodyFont: { size: 11 }, 
                        padding: 10, 
                        cornerRadius: 6,
                        mode: 'index',
                        intersect: false
                    },
                    datalabels: { 
                        display: function(context) {
                            return context.dataset.data[context.dataIndex] > 0;
                        },
                        font: { weight: '600', size: isMobile() ? 8 : 9 },
                        backgroundColor: function(context) {
                            return context.dataset.borderColor;
                        },
                        borderRadius: 3,
                        color: '#fff',
                        padding: { top: 2, bottom: 2, left: 4, right: 4 },
                        anchor: 'end',
                        align: 'top',
                        offset: 2,
                        formatter: v => v > 0 ? v : ''
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grace: '20%',
                        ticks: { 
                            precision: 0, 
                            font: { size: isMobile() ? 9 : 10 }, 
                            padding: 4,
                            maxTicksLimit: isMobile() ? 5 : 6
                        }, 
                        grid: { color: gridColor } 
                    },
                    x: { 
                        ticks: { 
                            font: { size: isMobile() ? 9 : 10, weight: '500' }, 
                            padding: 4,
                            maxRotation: isMobile() ? 45 : 0
                        }, 
                        grid: { display: false } 
                    }
                },
                animation: { duration: 500, easing: 'easeOutQuart' }
            };
        }

        function renderTrendChart() {
            const trendData = calcMonthlyTrend(rawData, false);
            trendChart = new Chart(document.getElementById('trendChart').getContext('2d'), {
                type: 'line',
                data: { labels: trendData.months, datasets: createTrendDatasets(trendData, groupColors) },
                options: getTrendChartOptions()
            });
        }

        function renderProdTrendChart() {
            const trendData = calcMonthlyTrend(rawData, true);
            prodTrendChart = new Chart(document.getElementById('prodTrendChart').getContext('2d'), {
                type: 'line',
                data: { labels: trendData.months, datasets: createTrendDatasets(trendData, prodColors, ' (PROD)') },
                options: getTrendChartOptions('rgba(220, 38, 38, 0.1)')
            });
        }

        function calcTechDistribution(data) {
            const techData = {};
            data.forEach(item => {
                const tech = item['æŠ€æœ¯ç±»'] || 'æœªçŸ¥';
                techData[tech] = (techData[tech] || 0) + 1;
            });
            return techData;
        }

        function renderTechChart() {
            const techData = calcTechDistribution(filteredData);
            const techEntries = Object.entries(techData).filter(k => k[1] > 0).sort((a, b) => b[1] - a[1]);
            const labels = techEntries.map(e => e[0]);
            const data = techEntries.map(e => e[1]);

            if (techChart) techChart.destroy();

            techChart = new Chart(document.getElementById('techChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: isMobile() ? '50%' : '55%',
                    plugins: {
                        legend: {
                            position: isMobile() ? 'bottom' : 'right',
                            labels: {
                                padding: isMobile() ? 8 : 10,
                                usePointStyle: true,
                                font: { size: isMobile() ? 9 : 10 },
                                boxWidth: isMobile() ? 12 : 15
                            }
                        },
                        datalabels: {
                            display: !isSmallMobile(),
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: isMobile() ? 10 : 11
                            },
                            formatter: (value, context) => {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = (value / total * 100);
                                return percentage > 3.5 ? percentage.toFixed(1) + '%' : '';
                            }
                        }
                    }
                }
            });
        }


        function renderDetailList() {
            const list = document.getElementById('detailList');
            document.getElementById('detailCount').textContent = filteredData.length;

            if (!filteredData.length) {
                list.innerHTML = '<div class="empty-state"><div class="icon">ğŸ”</div><p>æš‚æ— åŒ¹é…çš„æ•°æ®</p><p style="font-size:0.75rem;margin-top:4px;opacity:0.7">å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶</p></div>';
                return;
            }

            list.innerHTML = filteredData.map(item => {
                const title = item['issueæ ‡é¢˜'] || 'æ— æ ‡é¢˜';
                const type = Array.isArray(item['é—®é¢˜ç±»å‹']) ? item['é—®é¢˜ç±»å‹'].join(', ') : (item['é—®é¢˜ç±»å‹'] || 'æœªçŸ¥');
                const group = getModule(item) || '-';
                const mg = mapGroup(group);
                const date = item['parsed_create_date'] || item['åˆ›å»ºæ—¥æœŸ'] || '-';
                const sev = item['ä¸¥é‡ç¨‹åº¦'] || '-';
                const env = item['ç¯å¢ƒ'] || '-';
                const tech = item['æŠ€æœ¯ç±»'] || '-';
                const url = item['åŸå§‹URL'] || '';
                const urlBtn = url ? `<a href="${url}" target="_blank" class="btn-link" onclick="event.stopPropagation()">ğŸ”—</a>` : '';

                return `<div class="detail-item" onclick="this.classList.toggle('expanded')">
                    <div class="detail-header">
                        <span class="detail-title">${title.substring(0, 60)}${title.length > 60 ? '...' : ''}</span>
                        <div class="detail-meta">
                            <span class="badge group-${mg}">${mg}</span>
                            <span class="badge env-${env}">${env}</span>
                            <span class="badge severity-${sev}">${sev}</span>
                            <span class="detail-date">${date}</span>
                            ${urlBtn}
                        </div>
                    </div>
                    <div class="detail-body">
                        <div class="detail-grid">
                            <div class="detail-field"><span class="field-label">å®Œæ•´æ ‡é¢˜</span><span class="field-value">${title}</span></div>
                            <div class="detail-field"><span class="field-label">é—®é¢˜ç±»å‹</span><span class="field-value">${type}</span></div>
                            <div class="detail-field"><span class="field-label">åˆ›å»ºæ—¥æœŸ</span><span class="field-value">${date}</span></div>
                            <div class="detail-field"><span class="field-label">åŸå§‹æ¨¡å—</span><span class="field-value">${group}</span></div>
                            <div class="detail-field"><span class="field-label">æŠ€æœ¯ç±»</span><span class="field-value">${tech}</span></div>
                            <div class="detail-field"><span class="field-label">åŸå§‹é“¾æ¥</span><span class="field-value">${url ? `<a href="${url}" target="_blank" class="btn-link">ğŸ”— æ‰“å¼€</a>` : 'æ— '}</span></div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        document.addEventListener('DOMContentLoaded', () => {
            initDatePresets();
            initYearSelect();
            initChipEvents();
            setDateRange('thisMonth');
            ['startDate', 'endDate'].forEach(id => document.getElementById(id).addEventListener('change', () => {
                currentDateRange = 'custom';
                document.querySelectorAll('.date-preset').forEach(el => el.classList.remove('active'));
                document.querySelector('.date-preset[data-range="custom"]').classList.add('active');
                document.getElementById('dateCustom').style.display = 'flex';
                applyFilters();
            }));
            document.getElementById('searchKeyword').addEventListener('input', applyFilters);
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥é€‚åº”æ–°çš„å°ºå¯¸
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    if (typeChart || groupChart || techChart || prodPieChart) {
                        initCharts();
                    }
                }, 300);
            });
        });
    </script>
</body>
</html>